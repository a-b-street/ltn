<script lang="ts">
  import type { FeatureCollection } from "geojson";
  import { GeoJSON, Popup } from "svelte-maplibre";
  import {
    CellLayer,
    ModalFilterLayer,
    NeighbourhoodRoadLayer,
    OneWayLayer,
  } from "../layers";
  import { backend, printSpeed, showBeforeEdits } from "../stores";
  import type { RenderNeighbourhoodOutput } from "../wasm";

  let prefix = "before-edits-";

  let neighbourhoodGj: RenderNeighbourhoodOutput | null = $state(null);
  let modalFilterGj: FeatureCollection | null = $state(null);
  let turnRestrictionGj: FeatureCollection | null = $state(null);

  $effect(() => {
    if ($showBeforeEdits && neighbourhoodGj == null) {
      neighbourhoodGj = $backend!.renderNeighbourhoodBeforeEdits();
      modalFilterGj = $backend!.renderModalFiltersBeforeEdits();
      turnRestrictionGj = $backend!.renderTurnRestrictionsBeforeEdits();
    }
  });
</script>

{#if neighbourhoodGj}
  <GeoJSON data={neighbourhoodGj} generateId>
    <CellLayer show={$showBeforeEdits} {prefix} />
    <OneWayLayer show={$showBeforeEdits} {prefix} />

    <NeighbourhoodRoadLayer
      show={$showBeforeEdits}
      {prefix}
      interactive={true}
      maxShortcuts={neighbourhoodGj.maxShortcuts}
    >
      {#snippet linePopup()}
        <Popup openOn="hover">
          {#snippet children({ data })}
            {@const props = data!.properties!}
            {#if props.kind == "interior_road"}
              <p>
                {props.shortcuts} shortcuts through {props.name ??
                  "unnamed road"}
                ({printSpeed(props.speed_mph)})
              </p>
            {:else if props.kind == "main_road"}
              <p>
                Main road: {props.name ?? "unnamed road"}
                ({printSpeed(props.speed_mph)})
              </p>
            {/if}
          {/snippet}
        </Popup>
      {/snippet}
    </NeighbourhoodRoadLayer>
  </GeoJSON>
{/if}

{#if modalFilterGj && turnRestrictionGj}
  <ModalFilterLayer
    {prefix}
    show={$showBeforeEdits}
    interactive={false}
    {modalFilterGj}
    {turnRestrictionGj}
  />
{/if}
