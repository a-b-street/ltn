<script lang="ts">
  import type { Feature } from "geojson";
  import {
    LngLat,
    type MapGeoJSONFeature,
    type MapMouseEvent,
  } from "maplibre-gl";
  import { onMount } from "svelte";
  import {
    FillLayer,
    GeoJSON,
    LineLayer,
    MapEvents,
    Popup,
  } from "svelte-maplibre";
  import { constructMatchExpression, emptyGeojson } from "svelte-utils/map";
  import { SplitComponent } from "svelte-utils/top_bar_layout";
  import BackButton from "./BackButton.svelte";
  import {
    DotMarker,
    layerId,
    ModeLink,
    pageTitle,
    prettyPrintDistance,
    prettyPrintTime,
  } from "./common";
  import { ModalFilterLayer, RenderNeighbourhood } from "./layers";
  import {
    backend,
    ensurePointInVisibleBounds,
    mode,
    oneDestination,
    routePtA,
    routePtB,
  } from "./stores";
  import type { CompareRoute } from "./wasm";

  let hovered: (Feature & MapGeoJSONFeature) | undefined = $state();

  onMount(() => {
    // There seems to be a race with the Marker component, so we wait just a bit before updating.
    setTimeout(() => {
      if ($oneDestination) {
        ensurePointInVisibleBounds(oneDestination);
      }
    }, 10);
  });

  function previewRoutes(hovered: Feature | undefined): CompareRoute {
    if (!hovered) {
      return emptyGeojson() as CompareRoute;
    }
    return $backend!.compareRoute(
      new LngLat(hovered.properties!.pt1_x, hovered.properties!.pt1_y),
      $oneDestination,
      1.0,
    );
  }

  function compareRoute(f: Feature) {
    $routePtA = new LngLat(f.properties!.pt1_x, f.properties!.pt1_y);
    $routePtB = $oneDestination;
    $mode = { mode: "route", prevMode: "impact-one-destination" };
  }

  function onRightClick(e: MapMouseEvent) {
    // Move the first marker, for convenience
    $oneDestination = e.lngLat;
  }
  let perRoadGj = $derived($backend!.impactToOneDestination($oneDestination));
  let routeGj = $derived(previewRoutes(hovered));
  let routeBefore = $derived(
    routeGj.features.find((f) => f.properties.kind == "before"),
  );
  let routeAfter = $derived(
    routeGj.features.find((f) => f.properties.kind == "after"),
  );
</script>

<MapEvents oncontextmenu={onRightClick} />

<SplitComponent>
  {#snippet top()}
    <nav aria-label="breadcrumb">
      <ul>
        <li>
          <ModeLink mode={{ mode: "title" }} />
        </li>
        <li>
          <ModeLink mode={{ mode: "pick-neighbourhood" }} />
        </li>
        <li>
          <ModeLink mode={{ mode: "neighbourhood" }} />
        </li>
        <li>{pageTitle($mode.mode)}</li>
      </ul>
    </nav>
  {/snippet}

  {#snippet left()}
    <BackButton mode={{ mode: "neighbourhood" }} />

    <p>
      This shows the change in driving time to one destination from everywhere
      within the neighbourhood. Drag the pin around to change that destination.
    </p>

    <u style:color="red">Route before changes</u>
    {#if routeBefore}
      <p>
        {prettyPrintDistance(routeBefore.properties.distance)}, {prettyPrintTime(
          routeBefore.properties.time,
        )}
      </p>
    {:else if routeAfter}
      <p>
        No possible route (
        <i>This is usually a known software bug</i>
        )
      </p>
    {:else}
      <p>Hover on a road to compare</p>
    {/if}

    <u style:color="blue">Route after changes</u>
    {#if routeAfter}
      <p>
        {prettyPrintDistance(routeAfter.properties.distance)}, {prettyPrintTime(
          routeAfter.properties.time,
        )}
      </p>
    {:else if routeBefore}
      <p>
        No possible route (
        <i>This is usually a known software bug</i>
        )
      </p>
    {:else}
      <p>Hover on a road to compare</p>
    {/if}
  {/snippet}

  {#snippet main()}
    <RenderNeighbourhood>
      <FillLayer
        {...layerId("cells")}
        filter={["==", ["get", "kind"], "cell"]}
        paint={{
          "fill-color": ["get", "color"],
          "fill-opacity": 0.6,
        }}
      />
    </RenderNeighbourhood>

    <GeoJSON data={perRoadGj} generateId>
      <LineLayer
        {...layerId("interior-roads")}
        paint={{
          "line-color": [
            "interpolate-hcl",
            ["linear"],
            ["/", ["get", "time_after"], ["get", "time_before"]],
            1,
            "white",
            Math.max(perRoadGj.highest_time_ratio, 1.1),
            "red",
          ],
          "line-width": 5,
        }}
        manageHoverState
        onclick={(e) => compareRoute(e.features[0])}
        bind:hovered
      >
        <Popup openOn="hover">
          {#snippet children({ data })}
            {@const props = data!.properties!}
            <p>
              Time ratio: {(props.time_after / props.time_before).toFixed(1)}
            </p>
          {/snippet}
        </Popup>
      </LineLayer>
    </GeoJSON>

    <GeoJSON data={routeGj}>
      <LineLayer
        {...layerId("compare-route")}
        interactive={false}
        paint={{
          "line-width": 10,
          "line-color": constructMatchExpression(
            ["get", "kind"],
            {
              before: "red",
              after: "blue",
            },
            "red",
          ),
        }}
      />
    </GeoJSON>

    <ModalFilterLayer interactive={false} />

    <DotMarker bind:lngLat={$oneDestination} draggable>X</DotMarker>
  {/snippet}
</SplitComponent>
